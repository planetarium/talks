---
marp: true
html: true
---

# .NETì—ì„œ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë° ë°°ìš°ê¸°
ë¬¸ì„±ì› at Planetarium
@longfin / swen@planetariumhq.com

---

![image](https://user-images.githubusercontent.com/128436/66150659-9d291c00-e650-11e9-930c-6ebcc0021d1c.png)

---

![image](https://user-images.githubusercontent.com/128436/66151206-c8f8d180-e651-11e9-975f-02e6f14908b3.png)

---

# GitHub ë°–ì—ì„  ì´ë ‡ìŠµë‹ˆë‹¤. ğŸ˜…

- PHPë¡œ í”„ë¡œê·¸ë˜ë°ì„ ì²˜ìŒ ë°°ì›Œì„œ
- Javaë¡œ ì›¹ ê°œë°œì„ ì´ì–´ì„œ í•˜ë‹¤
- ìŠ¤íƒ€íŠ¸ì—…ì—ì„œ Python/TypeScriptë¡œ ì´ê²ƒì €ê²ƒ ë§Œì§€ë‹¤ê°€
- ì§€ê¸ˆì€ C#ìœ¼ë¡œ ë¸”ë¡ì²´ì¸ì„ ë§Œë“¤ê³  ìˆìŠµë‹ˆë‹¤. 

---

![image](https://user-images.githubusercontent.com/128436/66222903-2e5dc880-e70d-11e9-9a52-e3233276e5f0.png)

---

![image](https://user-images.githubusercontent.com/128436/66223007-66650b80-e70d-11e9-92ea-0533b72557a7.png)

---

# ê·¸ë˜ì„œ ì˜¤ëŠ˜ ì´ì•¼ê¸° í•  ê²ƒë“¤

- ë°°ê²½
- ë°°ìš´ ê²ƒë“¤ & í•´ ë³¸ ê²ƒë“¤
- ìœ ìš©í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤
- Q&A

---

# ë°°ê²½

---

![width: 800px](https://user-images.githubusercontent.com/128436/65844635-0e777f00-e372-11e9-862b-37e4a9e23875.png)

---

![width: 800px](https://user-images.githubusercontent.com/128436/65844718-4c74a300-e372-11e9-92b3-a30ef9f05bf7.png)

---

Unityì—ì„œ ì“¸ ìˆ˜ ìˆëŠ” **ë¸”ë¡ì²´ì¸ ì½”ì–´** ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë§Œë“­ë‹ˆë‹¤.

---

# ë¸”ë¡ì²´ì¸ì˜ êµ¬ì„± ìš”ì†Œ

- ì €ì¥ì†Œ (Storage)
- í•©ì˜ ë°©ì‹ (Consensus)
- ë„¤íŠ¸ì›Œí¬ (Network)

---

# ë„¤íŠ¸ì›Œí¬ ì—†ì´ ë§Œë“¤ì—ˆë˜ PoC

- ì €ì¥ì†Œ: íŒŒì¼ ê¸°ë°˜
- í•©ì˜ ë°©ì‹: Hashcash PoW(Proof of Work)
- ë„¤íŠ¸ì›Œí¬: ë“œë¡­ë°•ìŠ¤ ê³µìœ  ê¸°ëŠ¥ì„ í†µí•´ íŒŒì¼ì„ í†µì¨°ë¡œ ê³µìœ 

---

![image](https://user-images.githubusercontent.com/128436/66223967-bd6be000-e70f-11e9-8e73-011df28a7736.png)

---

> ë¸”ë¡ì²´ì¸ì€ ì´ì œ ëŒ€ê°• ì•Œ ê²ƒ ê°™ì€ë°, ìŠ¬ìŠ¬ ë„¤íŠ¸ì›Œí¬ ë§Œë“¤ì–´ì•¼ í•˜ì§€ ì•Šë‚˜ìš”?

---

# P2P ë¸”ë¡ì²´ì¸ ë„¤íŠ¸ì›Œí¬?

- ì„œë²„ê°€ ì—†ë‹¤ â‰  Listenì´ ì—†ë‹¤.
- ì˜ì™¸ë¡œ TCP ì„œë²„ì™€ í¬ê²Œ ë‹¤ë¥¼ ê²ƒë„ ì—†ê¸´ í•œë°, 
  - ì›¹ì„œë²„ë„ ì§ì ‘ ì§œë³¸ ì ì´ ì—†ë”ë¼ê³ ìš”. ğŸ˜…
- í”¼ì–´ì— ì—°ê²°í•˜ê³  ìˆëŠ” ì¤‘ì—ë„ ë‹¤ë¥¸ í”¼ì–´ë¡œë¶€í„° ì—°ê²°ì„ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.

---

![image](https://user-images.githubusercontent.com/128436/65845434-3a483400-e375-11e9-8d9a-3e6f0d1915a6.png)

---

# C#/.NETì—ì„œ ì§€ì›í•˜ëŠ” ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë° íŒ¨í„´ë“¤

- Event-based Asynchronous Pattern (EAP)
- Asynchronous Programming Pattern (APM)
- **Task-based Asynchronous Pattern (TAP)**
  - MSì—ì„œ ê¶Œì¥í•˜ëŠ” ë°©ë²•ì´ë¼ë‹ˆ ì´ê±¸ë¡œ í•´ë³´ê¸°ë¡œ

---

# ì²« ì¸ìƒ

```csharp
var httpResult = await client.GetAsync("https://google.com");
```

- í¸í•´ë³´ì¸ë‹¤. & ìˆì–´ë³´ì¸ë‹¤.
- ë‹¤ë¥¸ ì–¸ì–´(e.g. Python, TypeScript)ë‘ í¬ê²Œ ë‹¤ë¥´ì§€ ì•Šë„¤?
  - ì‚¬ì‹¤ ì´ ìª½ì´ ì›ì¡°ë¼ê³  í•©ë‹ˆë‹¤. ğŸ‘µğŸ¼
- ê·¼ë° ì €ëŸ¬ë©´ ë§¤ë²ˆ ìŠ¤ë ˆë“œê°€ ìƒê²¨ì„œ ê¸°ë‹¤ë¦¬ëŠ” ê±´ê°€?
  - ë‹¤í–‰íˆ ê·¸ë ‡ì§€ëŠ” ì•Šì•˜ìŠµë‹ˆë‹¤. ğŸ˜…

---

# ê·¸ëŸ¬ë˜ ì™€ì¤‘ì—â€¦

> h**g: ZeroMQ ë€ê±¸ ì“°ë©´ ì†Œì¼“ í”„ë¡œê·¸ë˜ë°ì„ ì•ˆì „í•˜ê²Œ í•  ìˆ˜ ìˆë‹¤ë˜ë°ìš”.

---

# ZeroMQ

- https://zeromq.org/
- POSIX ì†Œì¼“ê³¼ êµ‰ì¥íˆ ë¹„ìŠ·í•œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ì§€ë§Œ ì‚¬ì‹¤ì€ ì¤€ í”„ë ˆì„ì›Œí¬
- ë‹¤ì–‘í•œ í¸ì˜ ê¸°ëŠ¥ ì œê³µ
  - ë‹¤ì–‘í•œ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë° íŒ¨í„´ ì œê³µ
  - ê¸¸ì´ ì œí•œì´ ì—†ëŠ” ë©€í‹° íŒŒíŠ¸ ë©”ì‹œì§€
  - Listen / Connect ì˜ ìˆœì„œ ì œì•½ì´ ì—†ìŒ
  - ìë™ ì¬ì—°ê²° ì²˜ë¦¬

---

# ì‚¬ì¡± ğŸ‘€

- ì•Œì•„ë³´ë‹ˆ nanomsgë¼ëŠ” ê²Œ ìˆì—ˆê³ â€¦
- ë˜ ë‹¤ì‹œ ì•Œì•„ë³´ë‹ˆ nngë¼ëŠ” ê²Œ ìˆì—ˆê³ â€¦
- ì´ê±¸ C#/.NET ì–´ë–»ê²Œ ì“°ë‚˜ ë³´ë‹ˆ nng.NET ì´ë¼ëŠ” ê²Œ ìˆì—ˆëŠ”ë°â€¦
- ê¸°ê» ë‹¤ ë§Œë“¤ì—ˆë”ë‹ˆ Windows ì—ì„œë§Œ ê²¨ìš° ê²¨ìš° ëŒì•„ê°”ìŠµë‹ˆë‹¤.

â†’ ì´ì‹ì„±ì´ ì¢‹ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì•„ë´…ì‹œë‹¤.

---

# NetMQ

- https://github.com/zeromq/netmq
- C#/.NETì—ì„œ ë°”ë¡œ ì“¸ ìˆ˜ ìˆëŠ” êµ¬í˜„ì²´
- ë°”ì¸ë”©ì´ ì•„ë‹Œ ìˆœìˆ˜ C#ìœ¼ë¡œ í¬íŒ… ë˜ì—ˆê³ 
- ë‚˜ë¦„ëŒ€ë¡œ C# ìŠ¤íƒ€ì¼ë¡œ ì‘ì„± ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

---

![width:800px](https://user-images.githubusercontent.com/128436/65833418-2cf65f80-e30b-11e9-8abd-a47a9dfe5b68.png)

---

# ë°°ìš´ ê²ƒë“¤ & í•´ ë³¸ ê²ƒë“¤

---

# `Swarm<T>`

- ë„¤íŠ¸ì›Œí¬ íŒŒì‚¬ë“œ (Facade)
- ì„œë²„ / í´ë¼ì´ì–¸íŠ¸ ì—­í• ì„ ë™ì‹œì— ìˆ˜í–‰...
  - í•œë‹¤ê³¤ í•˜ì§€ë§Œ TCP ì„œë²„ì— ê°€ê¹ìŠµë‹ˆë‹¤.
- ë©”ì‹œì§€ ì†¡ìˆ˜ì‹  ì´ì™¸ì— ì£¼ê¸°ì ìœ¼ë¡œ ìˆ˜í–‰í•˜ëŠ” íŠ¹ìˆ˜í•œ ì‘ì—…ë“¤ë„ ìˆìŠµë‹ˆë‹¤.
  - íŠ¸ëœì­ì…˜ ì „íŒŒ
  - ë¼ìš°íŒ… í…Œì´ë¸” ê°±ì‹ 

â†’ ì˜¤ëŠ˜ ìì„¸íˆ ë‹¤ë£¨ì§„ ì•ŠìŠµë‹ˆë‹¤. ğŸ˜…

---

# `Task.WhenAll()`ì€ ì´ëŸ´ ë•Œ ë§ì´ ì“°ì‹œì£ ?

```csharp
var tasks = new Task[] 
{
    GetAsync("https://github.com/planetarium/libplanet"),
    GetAsync("https://github.com/planetarium/libplanet-explorer"),
    GetAsync("https://github.com/planetarium/libplanet-explorer-frontend")
};

await Task.WhenAll(tasks);
```

---

# ì´ëŸ° ì¼ì—ë„ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```csharp
var tasks = new Task[]
{
    ReceiveMessage(),
    BroadcastTxs(),
    RefreshTable(),
};

await Task.WhenAll(tasks);
```

---

# ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ í•´ë³¼ê¹Œìš”. ğŸ’¥

```csharp
var tasks = new Task[]
{
    ReceiveMessage(),
    BroadcastTxs(),
    RefreshTable(),
};

try 
{
    await Task.WhenAll(tasks);
}
catch (RefreshTableException)
{
    RebuildTable();
}
```

í•˜ì§€ë§Œ `RefreshTableException`ì€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

# ğŸ“„ë¥¼ ë´…ì‹œë‹¤.

> Creates a task that will complete when **all** of the `Task` objects in an enumerable collection have completed.

https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.whenall?view=netstandard-2.0

---

# `Task.WhenAny()`ë¥¼ ì¨ë³´ì£ .

```csharp
var tasks = new Task[]
{
    ReceiveMessage(),
    BroadcastTxs(),
    RefreshTable(),
};

try 
{
    await Task.WhenAny(tasks);
}
catch (RefreshTableException)
{
    RebuildTable();
}
```

í•˜ì§€ë§Œ ì—¬ì „íˆ `RefreshTableException`ì€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

# ë‹¤ì‹œ ğŸ“„ë¥¼ ë´…ì‹œë‹¤.

> Creates a task that will complete when any of the supplied tasks have completed.

https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.whenany?view=netstandard-2.0

ë³„ ë¬¸ì œ ì—†ëŠ” ê²ƒ ê°™ì€ë°ìš”?

---

# ë‹¤ì‹œ ğŸ“„ë¥¼ (ëê¹Œì§€) ë´…ì‹œë‹¤.

> **Returns**
> `Task<Task>`
> A task that represents **the completion of one of the supplied tasks**. The return task's Result is the task that completed.

https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.whenany?view=netstandard-2.0

ì™„ë£Œëœ `Task` ê·¸ëŒ€ë¡œ ë°˜í™˜í•˜ê¸° ë•Œë¬¸ì— ì•„ë¬´ëŸ° ì˜ˆì™¸ê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. 

---

# ê·¸ëŸ¼ ì–´ë–»ê²Œ í•˜ì£ ?

```csharp
var tasks = new Task[]
{
    ReceiveMessage(),
    BroadcastTxs(),
    RefreshTable(),
};

try 
{
    await await Task.WhenAny(tasks);
}
catch (RefreshTableException)
{
    RebuildTable();
}
```

---

# Dispose() ì—ì„  await ëª»í•˜ë‚˜ìš”?

```csharp
class Swarm<T> : IDisposable 
{
    public void Dispose() 
    {
        await SayGoodByeAsync(); // CS4033
    }
}
```

---

# `.Wait()` ë¼ëŠ”ê²Œ ìˆë‹¤ë˜ë°â€¦

```csharp
class Swarm<T> : IDisposable 
{
    public void Dispose() 
    {
        SayGoodByeAsync().Wait();
    }
}
```

ì—ëŸ¬ëŠ” ì—†ì–´ì¡Œë„¤ìš”. ê·¸ì¹˜ë§Œâ€¦

---

# `.Wait()` ë¼ëŠ”ê²Œ ìˆë‹¤ë˜ë°â€¦

```csharp
class Swarm<T> : IDisposable 
{
    public void Dispose() 
    {
        SayGoodByeAsync().Wait();
    }
}
```

`Swarm<T>.Dispose()` ê°€ `SynchronizationContext`ë¥¼ ê°–ëŠ” ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰í•˜ë©´ ë°ë“œë½ì´ ë°œìƒí•©ë‹ˆë‹¤.

---

# IAsyncDisposable

- https://docs.microsoft.com/ko-kr/dotnet/api/system.iasyncdisposable?view=netcore-3.0
- `public System.Threading.Tasks.ValueTask DisposeAsync();`
- í•˜ì§€ë§Œ .netstandard 2.0 (& Unity)ì—ì„œëŠ” ì“¸ ìˆ˜ê°€ ì—†ë„¤ìš”. ğŸ˜°

---

# ì ë‹¹íˆ íƒ€í˜‘í•˜ê¸°

```csharp
class Swarm<T>
{
    public Task StopAsync() 
    {
        await SayGoodByeAsync();
    }
}
```

- Libplanet(ë¼ì´ë¸ŒëŸ¬ë¦¬)ì—ì„œëŠ” `Dispose()` ëŒ€ì‹  `async StopAsync()`ë§Œì„ ì œê³µí•˜ê³ 
- ê²Œì„ì—ì„œëŠ” ì¼ì • ì‹œê°„ ë™ì•ˆë§Œ ì´ë¥¼ ê¸°ë‹¤ë¦¬ê³  ì¢…ë£Œí•˜ê²Œë” ì‘ì„±í•©ë‹ˆë‹¤.

---

# Unityì—ì„œ ì˜ ëŒì•„ê°ˆê¹Œìš”?

- Unityì—ì„œ ì‚¬ìš©ë˜ëŠ” C#/.NET ëŸ°íƒ€ì„ì€ Mono
  - ì •ê·œ ë²„ì „ì´ ì•„ë‹Œ Bleeding Edge
- NetMQëŠ” .NET Frameworkì™€ .NET Coreë¥¼ ëª¨ë‘ ì§€ì›í•˜ê¸´ í•˜ë‹ˆâ€¦ ê´œì°®ì§€ ì•Šì„ê¹Œìš”?

---

![image](https://user-images.githubusercontent.com/128436/66052168-1c442480-e56b-11e9-86a1-8c422f55f2d1.png)

---

![width:800px](https://user-images.githubusercontent.com/128436/66052343-6decaf00-e56b-11e9-86fd-1c096e54e0dd.png)

https://github.com/zeromq/netmq/issues/631

---

# ë²”ì¸ì€ AsyncIO ğŸ•µï¸â€â™‚ï¸

- https://github.com/somdoron/AsyncIO
- NetMQì—ì„œ ë¹„ë™ê¸° ì†Œì¼“ì´ í•„ìš”í• ë• .NET ì†Œì¼“ ëŒ€ì‹  ì´ê±¸ ì‚¬ìš©í•˜ëŠ”ë°â€¦
- ì‹¤í–‰í•˜ëŠ” í”Œë«í¼ì— ë”°ë¼ IOCP / .NET Completion Portë¥¼ êµ¬ë¶„í•©ë‹ˆë‹¤.
- Unity + Windowsì—ì„  IOCPê°€ ì œëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ğŸ˜¥


---
# May the `Force` be with you

```
        static Swarm()
        {
            if (!(Type.GetType("Mono.Runtime") is null))
            {
                ForceDotNet.Force();
            }
        }
```

https://github.com/planetarium/libplanet/blob/master/Libplanet/Net/Swarm.cs#L76-L82

---

# ë™ê¸° ë©”ì†Œë“œë¥¼ ë¹„ë™ê¸°ë¡œ ë§Œë“¤ê¸°

- NetMQ(<4.0.0.239-pre)ì˜ APIëŠ” ëª¨ë‘ *ë™ê¸°* ë©”ì†Œë“œ
- ì•„ë¬´ë¦¬ ê²‰ì˜ ì¸í„°í˜ì´ìŠ¤ë¥¼ TAPë¡œ ì‘ì„±í•´ë„ ì†Œì¼“ì€ ë¸”ë¡ë  ìˆ˜ ë°–ì— ì—†ëŠ” êµ¬ì¡°

---

```csharp
public async SendMessage(Peer peer)
{
    Dealer socket = CreateSocket(peer);
    socket.Connect(); // Blocking!
    socket.Send("hello"); // and, Blocking!
    socket.Receive();
}
```

---

```csharp
    internal static class NetMQSocketExtension
    {
        public static async Task SendFrameAsync(
            this IOutgoingSocket socket,
            byte[] data,
            TimeSpan? timeout = null,
            TimeSpan? delay = null,
            CancellationToken cancellationToken = default(CancellationToken))
        {
            TimeSpan delayNotNull = delay ?? TimeSpan.FromMilliseconds(100);
            TimeSpan elapsed = TimeSpan.Zero;

            while (!socket.TrySendFrame(data))
            {
                await Task.Delay(delayNotNull, cancellationToken);

                elapsed += delayNotNull;
                if (elapsed > timeout)
                {
                    throw new TimeoutException(
                        "The operation exceeded the specified time: " +
                        $"{timeout}."
                    );
                }
            }
        }
    }
```

---

# ê·¼ë³¸ì ì¸ ë¬¸ì œê°€ ë‚¨ì•„ ìˆìŠµë‹ˆë‹¤.

- ZeroMQ / NetMQì˜ ëª¨ë“  ì†Œì¼“ì€ **ìŠ¤ë ˆë“œ-ì•ˆì „(Thread-safe)í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**
  - TMI) ìš”ê±´ ë²„ê·¸ê°€ ì•„ë‹ˆë¼ ì„¤ê³„ ì² í•™ì— í•´ë‹¹í•˜ëŠ” ë¶€ë¶„ì´ë¼ê³  í•˜ë„¤ìš”.
- ì‹¤í–‰ ë¬¸ë§¥ì´ ë³´ì¡´ë˜ëŠ” í™˜ê²½ì´ë¼ë©´ ê´œì°®ì§€ë§Œ, ê·¸ë ‡ì§€ ì•Šì€ í™˜ê²½ì—ì„œëŠ” ì˜¤ì‘ë™ì˜ ì›ì¸ì´ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

![image](https://user-images.githubusercontent.com/128436/66147690-50dadd80-e64a-11e9-9a36-33a39cff3d65.png)

---

![image](https://user-images.githubusercontent.com/128436/66147798-85e73000-e64a-11e9-88b0-03c46e3ced94.png)

---

# ì•„ì´ë””ì–´ëŠ” ì´ë ‡ìŠµë‹ˆë‹¤.

- `async`/`await` ë¥¼ ì‚¬ìš©í•˜ëŠ” í™˜ê²½(`Task`)ë¥¼ êµ¬ë¶„í•˜ëŠ” ì‹¤í–‰ ë‹¨ìœ„(`NetMQRuntime`)ì„ ë§Œë“¤ê³ 
- `NetMQPoller`ë¡œ ë‹¨ì¼ ìŠ¤ë ˆë“œë¥¼ ë¶™ì—¬ ë‘” ë‹¤ìŒ
- `SynchronizationContext.SetSynchronizationContext()`ë¥¼ í†µí•´ ì‹¤í–‰ ë‹¨ìœ„ ì•ˆì—ì„œ ë™ê¸°í™” ë¬¸ë§¥ì„ ê³ ì •í•©ë‹ˆë‹¤.

---

![image](https://user-images.githubusercontent.com/128436/66148161-40773280-e64b-11e9-9511-e9a0350932be.png)

https://github.com/zeromq/netmq/pull/802

---

```csharp
async Task ServerAsync()
{
    using (var server = new RouterSocket("inproc://async"))
    {
        for (int i = 0; i < 1000; i++)
        {
            var (routingKey, more) = await server.ReceiveRoutingKeyAsync();
            var (message, _) = await server.ReceiveFrameStringAsync();

            // TODO: process message

            await Task.Delay(100);
            server.SendMoreFrame(routingKey);
            server.SendFrame("Welcome");
        }
    }
}
```

---

```csharp
async Task ClientAsync()
{
    using (var client = new DealerSocket("inproc://async"))
    {
        for (int i = 0; i < 1000; i++)
        {
            client.SendFrame("Hello");
            var (message, more) = await client.ReceiveFrameStringAsync();

            // TODO: process reply

            await Task.Delay(100);
        }
    }
}

static void Main(string[] args)
{
    using (var runtime = new NetMQRuntime())
    {
        runtime.Run(ServerAsync(), ClientAsync());
    }
}
```

---

# ê·¸ëŸ°ë° ë¹ ì§„ê²Œ ìˆë”ë¼ê³ ìš”.

- ì¶”ê°€ëœ ë¹„ë™ê¸° ë©”ì†Œë“œë“¤ì´ ì·¨ì†Œ í† í°(`CancellationToken`)ì„ ë°›ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ğŸ˜¨
  - ë•íƒì— íƒ€ì„ ì•„ì›ƒë„ êµ¬í˜„í•  ìˆ˜ ì—†ì—ˆì£ .
- ì €í¬ê°€ ì• ìš©í•˜ë˜ ë©€í‹° íŒŒíŠ¸ ë©”ì„¸ì§€ ì§€ì›ë„ ì—†ì—ˆìŠµë‹ˆë‹¤. ğŸ˜°
- ë¤ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë„ ê¹¨ì§€ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ğŸ˜­

---

# ì œë©‹ëŒ€ë¡œ ì˜¤í”ˆ ì†ŒìŠ¤ ì² í•™

- ìƒìš© ì½”ë“œì˜ í€„ë¦¬í‹° â‰¥ ì˜¤í”ˆ ì†ŒìŠ¤ ì½”ë“œì˜ í€„ë¦¬í‹°
- **í˜¼ì êµ¬í˜„í•œ ì½”ë“œì˜ í€„ë¦¬í‹° ï¼œ ê°™ì´ êµ¬í˜„í•œ ì½”ë“œì˜ í€„ë¦¬í‹°**

---

# ê·¸ëŸ°ê³ ë¡œ ì§ì ‘ ê³ ì³ë³´ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.

```csharp
        public static async Task<NetMQMessage> ReceiveMultipartMessageAsync(
            [NotNull] this NetMQSocket socket, 
            int expectedFrameCount = 4,
            CancellationToken cancellationToken = default(CancellationToken))
        {
            var message = new NetMQMessage(expectedFrameCount);

            while (true)
            {
                (byte[] bytes, bool more) = await socket.ReceiveFrameBytesAsync(cancellationToken);
                message.Append(bytes);

                if (!more)
                {
                    break;
                }
            }

            return message;
        }
```

---

```csharp
        public static Task<(byte[], bool)> ReceiveFrameBytesAsync(
            [NotNull] this NetMQSocket socket
        )
        {
            if (NetMQRuntime.Current == null)
                throw new InvalidOperationException("NetMQRuntime must be created before calling async functions");
            socket.AttachToRuntime();
            var msg = new Msg();
            msg.InitEmpty();
            if (socket.TryReceive(ref msg, TimeSpan.Zero))
            {
                var data = msg.CloneData();
                bool more = msg.HasMore;
                msg.Close();
                return Task.FromResult((data, more));
            }

            TaskCompletionSource<(byte[], bool)> source = new TaskCompletionSource<(byte[], bool)>();
            
            void Listener(object sender, NetMQSocketEventArgs args)
            {
                if (socket.TryReceive(ref msg, TimeSpan.Zero))
                {
                    var data = msg.CloneData();
                    bool more = msg.HasMore;
                    msg.Close();
                    socket.ReceiveReady -=  Listener;
                    source.SetResult((data, more));
                }
            }
            socket.ReceiveReady += Listener;
            return source.Task;
        }
```

---

```csharp
        public static Task<(byte[], bool)> ReceiveFrameBytesAsync(
            [NotNull] this NetMQSocket socket, 
            CancellationToken cancellationToken = default(CancellationToken)
        )
        {
            // ...

            TaskCompletionSource<(byte[], bool)> source = new TaskCompletionSource<(byte[], bool)>();
            cancellationToken.Register(() => source.SetCanceled());
            
            // ...
            return source.Task;
        }
```

---

# ë‹¤í–‰íˆ ì—…ìŠ¤íŠ¸ë¦¼ì—ë„ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ğŸ˜‰

![width:720px](https://user-images.githubusercontent.com/128436/66149658-841f6b80-e64e-11e9-8d09-023a17835474.png)

---

# ìœ ìš©í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤

---

# AsyncEx

- https://github.com/StephenCleary/AsyncEx
- .NETì—ì„œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥/APIì˜ ë¹„ë™ê¸° API 
  - `lock` â†’ `AsyncLock`
  - `BlockingCollection<T>` â†’ `AsyncCollection<T>`
  - `AutoResetEvent` â†’ `AsyncAutoResetEvent`
- ì—¬ëŸ¬ê°€ì§€ ìœ í‹¸ë¦¬í‹°
  - `AsyncContext`
  - `AsyncLazy`
  - `CancellationTokenHelpers`

---

# `AsyncLock`

```csharp
var _mutex = new object();
lock (_mutex)
{
    await RunAsync(); // CS1996 Cannot await in the body of a lock statement
}
```

```csharp
var _mutex = new AsyncLock();
using (await _mutex.LockAsync()) 
{
    await RunAsync();
}
```

---

# `AsyncCollection<T>`

```csharp
var requests = new AsyncCollection<Message>();

// Add
await requests.AddAsync(new Message("Hello"));

// receive
while (true)
{
    var request = await requests.TakeAsync(cancellationToken);
}
```

---

# `AsyncAutoResetEvent`

```csharp
class Swarm
{
    public BlockChain BlockChain { get; }
    public AsyncAutoResetEvent BlockReceived { get; }

    private void ReceiveBlock() 
    {
        // ...
        BlockReceived.Set();
    }
}

// Unittest
[Fact]
public async Task BlockReceiving() 
{
    var swarm = new Swarm();
    await swarm.RunAsync();

    // ...

    await swarm.BlockReceived;
    Assert.Contains(swarm.BlockChain, block);
}
```

---

# AsyncEnumerable

- https://github.com/Dasync/AsyncEnumerable
- C# 8.0 ì— ì¶”ê°€ë˜ëŠ” Async Streamsë“±ì„ ë¯¸ë¦¬ ì¨ ë³¼ ìˆ˜ ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬

---

# Streams

```csharp
// Producer
public IEnumerable<byte[]> GetStreams()
{
    foreach (byte[] bytes in GetData()) 
    {
        yield return bytes;
    }
}

// Consumer
foreach (byte[] chunk in GetStreams())
{
    Console.WriteLine($"Received data size = {chunk.Count}");
}
```

---

# Async Streams

```csharp
// Producer
public async IAsyncEnumerable<byte[]> GetStreamsAsync()
{
    foreach (byte[] bytes in await GetDataAsync()) 
    {
        yield return bytes;
    }
}

// Consumer
await foreach (var chunk in GetStreamsAsync())
{
    Console.WriteLine($"Received data size = {chunk.Count}");
}
```

---

# Async Streams (`AsyncEnumerable`)

```csharp
using Dasync.Collections;

// Producer
public IAsyncEnumerable<byte[]> GetStreamsAsync() 
{
    return new AsyncEnumerable(async yield =>
    {
        foreach (byte[] bytes in await GetDataAsync())
        {
            await yield.ReturnAsync(bytes);
        }
    });
}

// Consumer
await asyncStreams.ForEachAsync(chunk => 
{
    Console.WriteLine($"Received data count = {chunk.Count}");
});

```

---

# `ParallelForeachAsync()`

```csharp
await uris.ParallelForEachAsync(
    async uri =>
    {
        var str = await httpClient.GetStringAsync(
            uri, 
            cancellationToken
        );
        result.Add(str);
    },
    maxDegreeOfParallelism: 5,
    cancellationToken: cancellationToken
);
```

---

# í•¨ê»˜ í•˜ì‹¤ ë¶„ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.

<img src="https://user-images.githubusercontent.com/128436/66122529-e3fc1f00-e61a-11e9-9559-4dcbc45a72e4.png" style="width:400px; display: block; margin: 0 auto 0 auto;" />

http://bit.ly/plnt-hire-2019

---

# Q&A
